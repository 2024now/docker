#!/bin/bash

# æ£€æŸ¥æ˜¯å¦ä»¥ root æƒé™è¿è¡Œ
if [ "$EUID" -ne 0 ]; then 
    echo "è¯·ä»¥ root æƒé™è¿è¡Œæ­¤è„šæœ¬"
    echo "ä½¿ç”¨æ–¹æ³•: sudo bash $0"
    exit 1
fi

# è®¾ç½®é”™è¯¯å¤„ç†
set -e

# æ‰“å°æ­¥éª¤ä¿¡æ¯çš„å‡½æ•°
print_step() {
    echo "================================================"
    echo ">>> $1"
    echo "================================================"
}

# æ£€æŸ¥å‘½ä»¤æ˜¯å¦æ‰§è¡ŒæˆåŠŸçš„å‡½æ•°
check_status() {
    if [ $? -eq 0 ]; then
        echo "âœ… $1 æˆåŠŸ"
    else
        echo "âŒ $1 å¤±è´¥"
        exit 1
    fi
}

# å¼€å§‹å®‰è£…
print_step "å¼€å§‹å®‰è£… Docker å’Œ Docker Compose"

# 1. æ›´æ–°è½¯ä»¶åŒ…ç´¢å¼•
print_step "1. æ›´æ–°è½¯ä»¶åŒ…ç´¢å¼•"
apt update
check_status "æ›´æ–°è½¯ä»¶åŒ…ç´¢å¼•"

# 2. å®‰è£…ä¾èµ–åŒ…
print_step "2. å®‰è£…ä¾èµ–åŒ…"
apt install -y apt-transport-https ca-certificates curl software-properties-common
check_status "å®‰è£…ä¾èµ–åŒ…"

# 3. æ·»åŠ  Docker çš„å®˜æ–¹ GPG å¯†é’¥
print_step "3. æ·»åŠ  Docker çš„å®˜æ–¹ GPG å¯†é’¥"
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -
check_status "æ·»åŠ  GPG å¯†é’¥"

# 4. è®¾ç½® Docker ç¨³å®šç‰ˆä»“åº“
print_step "4. è®¾ç½® Docker ä»“åº“"
add-apt-repository -y "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
check_status "è®¾ç½® Docker ä»“åº“"

# 5. å†æ¬¡æ›´æ–°è½¯ä»¶åŒ…ç´¢å¼•
print_step "5. æ›´æ–°è½¯ä»¶åŒ…ç´¢å¼•"
apt update
check_status "æ›´æ–°è½¯ä»¶åŒ…ç´¢å¼•"

# 6. å®‰è£… Docker CE
print_step "6. å®‰è£… Docker CE"
apt install -y docker-ce
check_status "å®‰è£… Docker CE"

# 7. æ£€æŸ¥ Docker çŠ¶æ€
print_step "7. æ£€æŸ¥ Docker çŠ¶æ€"
systemctl start docker
systemctl enable docker
check_status "Docker æœåŠ¡å¯åŠ¨"

# 8. å®‰è£… Docker Compose
print_step "8. å®‰è£… Docker Compose"
curl -L "https://github.com/docker/compose/releases/download/v2.4.1/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose
check_status "å®‰è£… Docker Compose"

# 9. éªŒè¯å®‰è£…
print_step "å®‰è£…éªŒè¯"
echo "Docker ç‰ˆæœ¬:"
docker --version
echo "Docker Compose ç‰ˆæœ¬:"
docker-compose --version

# 10. é‡å¯ Docker æœåŠ¡
print_step "é‡å¯ Docker æœåŠ¡"
systemctl restart docker
check_status "é‡å¯ Docker æœåŠ¡"

# 11. æ·»åŠ å½“å‰ç”¨æˆ·åˆ° docker ç”¨æˆ·ç»„
if [ "$SUDO_USER" ]; then
    print_step "å°†ç”¨æˆ· $SUDO_USER æ·»åŠ åˆ° docker ç»„"
    usermod -aG docker $SUDO_USER
    check_status "æ·»åŠ ç”¨æˆ·åˆ° docker ç»„"
fi

echo ""
echo "ğŸ‰ Docker å’Œ Docker Compose å®‰è£…å®Œæˆï¼"
echo "è¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥åº”ç”¨ç»„æ›´æ”¹ï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼š"
echo "newgrp docker"
echo ""
echo "æ‚¨å¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥æµ‹è¯• Dockerï¼š"
echo "docker run hello-world"
